<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>QR 인식 · 8자리 검사</title>
  <style>
    :root{
      --bg:#0b0f14; --fg:#f5f7fa; --muted:#9aa4b2; --accent:#4c9fff; --danger:#ff5566; --ok:#24d27e;
      --card:#11161d; --border:#1d2430;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--fg); font-family: system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,Helvetica,Arial,sans-serif;
    }
    header{
      padding:16px; text-align:center; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#0d141d,#0b0f14);
      position:sticky; top:0; z-index:10;
    }
    header h1{margin:0; font-size:18px; letter-spacing: .2px}
    main{padding:16px; max-width:700px; margin:0 auto}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .preview{
      position:relative; aspect-ratio: 9/16; width:100%; background:#000;
    }
    video{
      width:100%; height:100%; object-fit:cover; display:block; background:#000;
    }
    .overlay{
      position:absolute; inset:0; pointer-events:none; display:flex; align-items:center; justify-content:center;
    }
    .frame{
      width:70%; aspect-ratio:1/1; border:2px dashed rgba(255,255,255,.35); border-radius:12px;
      box-shadow: inset 0 0 0 9999px rgba(0,0,0,.25);
      backdrop-filter: blur(2px);
    }
    .controls{
      display:flex; gap:12px; padding:12px; border-top:1px solid var(--border); flex-wrap:wrap; align-items:center; justify-content:center;
    }
    button{
      flex:1 1 auto; min-width:120px; padding:14px 16px; border-radius:12px; border:1px solid var(--border); background:#131a23;
      color:var(--fg); font-size:16px; font-weight:600; cursor:pointer; transition:.15s ease;
      touch-action:manipulation;
    }
    button:hover{transform:translateY(-1px)}
    .on{background: var(--accent); color:#041423; border-color:transparent}
    .off{background:#1b2330}
    .muted{color:var(--muted); font-size:13px; text-align:center; padding:8px 12px 14px}
    .row{display:flex; gap:12px; align-items:center; justify-content:center; padding:0 12px 12px; flex-wrap:wrap}
    select{
      appearance:none; -webkit-appearance:none; -moz-appearance:none;
      background:#0f141c; color:var(--fg); border:1px solid var(--border); border-radius:10px; padding:12px 14px; min-width:220px;
      font-size:14px; flex:1 1 220px;
    }
    .chip{font-size:12px; color:var(--muted)}
    .stat{
      padding:12px; border-top:1px solid var(--border); display:flex; gap:12px; flex-wrap:wrap; justify-content:space-between; align-items:center;
    }
    .tag{
      padding:6px 10px; border-radius:999px; background:#0f1722; border:1px solid var(--border); font-size:12px; color:var(--muted)
    }

    /* 커스텀 알림(모달) */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:1000;
    }
    .modal{
      width:min(500px,90vw); background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.5); animation:pop .15s ease-out;
    }
    @keyframes pop{from{transform:scale(.96); opacity:0} to{transform:scale(1); opacity:1}}
    .modal h3{margin:0 0 6px; font-size:18px}
    .modal p{margin:8px 0; color:var(--muted)}
    .kbd{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; background:#0e1420; border:1px solid var(--border); border-radius:8px; padding:4px 8px;}
    .result{
      margin-top:8px; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#0e1420; display:flex; gap:8px; align-items:center; justify-content:space-between;
    }
    .yes{color:var(--ok)}
    .no{color:var(--danger)}
    .modal .actions{display:flex; gap:10px; margin-top:14px}
    .modal .actions button{flex:1 1 auto}
    .auto-close-hint{font-size:12px; color:var(--muted); text-align:right}
    .hidden{display:none}

    /* 모바일 최적화 */
    @media (max-width:480px){
      header h1{font-size:16px}
      button{font-size:15px; padding:12px 14px}
    }
  </style>
</head>
<body>
  <header>
    <h1>QR 인식 → 앞 8자리 숫자 검사</h1>
  </header>

  <main>
    <section class="card">
      <div class="preview">
        <video id="video" playsinline muted></video>
        <div class="overlay"><div class="frame" aria-hidden="true"></div></div>
      </div>

      <div class="controls">
        <button id="toggleBtn" class="off" type="button">카메라 켜기</button>
        <button id="flashBtn" type="button" title="일부 기기만 지원" disabled>플래시</button>
      </div>

      <div class="row">
        <select id="deviceSelect" title="PC에서는 0번 캠(첫 번째) 자동 선택">
          <option value="">카메라 선택(자동)</option>
        </select>
        <span class="chip">모바일: 후면 카메라 우선</span>
      </div>

      <div class="stat">
        <span class="tag" id="lastRaw">마지막 원본: -</span>
        <span class="tag" id="lastTrim">앞 8자리: -</span>
      </div>

      <div class="muted">
        카메라 권한을 허용하세요. 스캔되면 커스텀 알림으로 <strong>값</strong>과 <strong>배열 포함 여부</strong>가 표시되고, 닫기 버튼 또는 <strong>2초 무활동</strong>으로 자동 닫힙니다.
      </div>
    </section>
  </main>

  <!-- 커스텀 알림 모달 -->
  <div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <h3 id="modalTitle">스캔 결과</h3>
      <p id="modalRaw">원본 값: <span class="kbd">-</span></p>
      <div class="result">
        <div>앞 8자리: <span id="modalFirst8" class="kbd">-</span></div>
        <strong id="modalState" class="no">없다</strong>
      </div>
      <div class="actions">
        <button id="closeModal" type="button">닫기</button>
      </div>
      <div class="auto-close-hint" id="autoHint">2초 후 자동 닫힘</div>
    </div>
  </div>

  <script>
  // ===================== 사용자 편집 영역 =====================
  // 배열: 여기 값들을 원하는 값으로 바꾸세요(문자열 8자리 권장).
  const TARGET_VALUES = [
    "12345678", "87654321", "00000000", "11112222",
    // ... 필요 값 추가
  ];
  // 스캔 시 중복 알림 방지 대기(ms)
  const DEBOUNCE_MS = 1200;
  // =========================================================

  const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  const video = document.getElementById('video');
  const toggleBtn = document.getElementById('toggleBtn');
  const deviceSelect = document.getElementById('deviceSelect');
  const flashBtn = document.getElementById('flashBtn');
  const lastRawEl = document.getElementById('lastRaw');
  const lastTrimEl = document.getElementById('lastTrim');

  const backdrop = document.getElementById('backdrop');
  const modalRaw = document.getElementById('modalRaw').querySelector('.kbd');
  const modalFirst8 = document.getElementById('modalFirst8');
  const modalState = document.getElementById('modalState');
  const closeModalBtn = document.getElementById('closeModal');
  const autoHint = document.getElementById('autoHint');

  let stream = null;
  let scanning = false;
  let scanLoopId = null;
  let lastShown = { value: null, time: 0 };
  let autoCloseTimer = null;
  let barcodeDetectorSupported = ('BarcodeDetector' in window);
  let trackForTorch = null;

  async function listCameras(){
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d=>d.kind==='videoinput');
      deviceSelect.innerHTML = '<option value="">카메라 선택(자동)</option>';
      cams.forEach((cam,idx)=>{
        const opt = document.createElement('option');
        opt.value = cam.deviceId;
        opt.textContent = cam.label || `카메라 ${idx+1}`;
        deviceSelect.appendChild(opt);
      });
    }catch(e){
      // 권한 전에는 label이 비어있을 수 있음
    }
  }

  function getPreferredConstraints(){
    // 모바일: 후면 카메라
    if(isMobile){
      return { video: { facingMode: { ideal: 'environment' } , width:{ideal:1280}, height:{ideal:720} , focusMode: 'continuous'} , audio:false };
    }
    // PC: 0번 캠(첫 번째 videoinput)
    const selected = deviceSelect.value;
    if(selected){
      return { video: { deviceId: { exact: selected }, width:{ideal:1280}, height:{ideal:720} }, audio:false };
    }
    // 아직 enumerate 전이면 우선 기본
    return { video: { width:{ideal:1280}, height:{ideal:720} }, audio:false };
  }

  async function startCamera(){
    if(stream) await stopCamera();
    try{
      // 먼저 카메라 목록
      await listCameras();

      // PC에서 명시적으로 첫 번째 카메라를 고르도록 시도
      if(!isMobile && !deviceSelect.value){
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d=>d.kind==='videoinput');
        if(cams.length>0){
          deviceSelect.value = cams[0].deviceId; // 0번 캠
        }
      }

      stream = await navigator.mediaDevices.getUserMedia( getPreferredConstraints() );
      video.srcObject = stream;
      await video.play();

      // 토치(플래시) 지원 여부
      trackForTorch = stream.getVideoTracks()[0] || null;
      const cap = trackForTorch?.getCapabilities?.() || {};
      if(cap.torch){
        flashBtn.disabled = false;
      }else{
        flashBtn.disabled = true;
      }

      scanning = true;
      toggleBtn.textContent = '카메라 끄기';
      toggleBtn.classList.remove('off'); toggleBtn.classList.add('on');

      // 스캔 루프 시작
      runScanLoop();
    }catch(err){
      alert('카메라를 시작할 수 없습니다.\n권한을 허용했는지, 다른 앱이 카메라를 사용 중인지 확인해주세요.\n\n' + err);
      await stopCamera();
    }
  }

  async function stopCamera(){
    scanning = false;
    if(scanLoopId) cancelAnimationFrame(scanLoopId);
    scanLoopId = null;
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    toggleBtn.textContent = '카메라 켜기';
    toggleBtn.classList.remove('on'); toggleBtn.classList.add('off');
  }

  toggleBtn.addEventListener('click', ()=>{
    if(scanning) stopCamera(); else startCamera();
  });
  deviceSelect.addEventListener('change', ()=>{
    // 선택 바꾸면 재시작
    if(scanning) startCamera();
  });

  // 토치 토글(일부 기기만 지원)
  let torchOn = false;
  flashBtn.addEventListener('click', async ()=>{
    if(!trackForTorch) return;
    const cap = trackForTorch.getCapabilities?.() || {};
    if(!cap.torch) return;
    torchOn = !torchOn;
    try{
      await trackForTorch.applyConstraints({ advanced: [{ torch: torchOn }] });
      flashBtn.textContent = torchOn ? '플래시 끄기' : '플래시 켜기';
    }catch(e){
      console.warn('Torch error', e);
    }
  });

  // 스캔 구현 (BarcodeDetector 우선)
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  const detector = barcodeDetectorSupported ? new BarcodeDetector({ formats: ['qr_code'] }) : null;

  async function runScanLoop(){
    const step = async ()=>{
      if(!scanning || video.readyState < 2){ scanLoopId = requestAnimationFrame(step); return; }

      try{
        // 캔버스에 현재 프레임 그리기
        const vw = video.videoWidth, vh = video.videoHeight;
        canvas.width = vw; canvas.height = vh;
        ctx.drawImage(video, 0, 0, vw, vh);

        if(detector){
          const bitmap = await createImageBitmap(canvas);
          const codes = await detector.detect(bitmap);
          bitmap.close?.();
          if(codes && codes.length){
            handleCode(codes[0].rawValue ?? codes[0].rawValue || codes[0].rawValue /* 안전 */);
          }
        }else{
          // 미지원 브라우저 안내
          // (필요 시 jsQR 같은 라이브러리를 추가할 수 있습니다)
          // 1초에 한 번만 알림
          const now = performance.now();
          if(now - lastShown.time > 1000 && !backdrop.style.display){
            showModal('이 브라우저는 QR 스캔을 지원하지 않습니다.', '', false, true);
          }
        }
      }catch(e){
        console.warn('detect error', e);
      }

      // 너무 과도한 호출을 피하기 위해 약간 쉬기
      await new Promise(r=>setTimeout(r, 150));
      scanLoopId = requestAnimationFrame(step);
    };
    scanLoopId = requestAnimationFrame(step);
  }

  function extractFirst8Digits(str){
    const digits = (str || '').replace(/\D/g,'');
    return digits.slice(0,8);
  }

  function handleCode(raw){
    const now = performance.now();
    // 동일 값 연속 표시 방지
    if(lastShown.value === raw && (now - lastShown.time) < DEBOUNCE_MS) return;

    const first8 = extractFirst8Digits(raw);
    lastRawEl.textContent = '마지막 원본: ' + (raw || '-');
    lastTrimEl.textContent = '앞 8자리: ' + (first8 || '-');

    // 8자리 미만인 경우도 알림
    const exists = first8 && TARGET_VALUES.includes(first8);
    showModal(raw, first8, exists);
    lastShown = { value: raw, time: now };
  }

  function showModal(raw, first8, exists, infoOnly=false){
    modalRaw.textContent = String(raw ?? '-');
    modalFirst8.textContent = first8 ? first8 : '-';
    if(infoOnly){
      modalState.textContent = '미지원';
      modalState.classList.remove('yes'); modalState.classList.add('no');
    }else{
      modalState.textContent = exists ? '있다' : '없다';
      modalState.classList.toggle('yes', exists);
      modalState.classList.toggle('no', !exists);
    }

    backdrop.style.display = 'flex';

    // 자동 닫힘(2초 동안 아무런 클릭이 없어도 닫기)
    clearTimeout(autoCloseTimer);
    autoHint.textContent = '2초 후 자동 닫힘';
    let start = Date.now();
    const tick = ()=>{
      const remain = 2000 - (Date.now() - start);
      if(remain <= 0) { closeModal(); return; }
      autoHint.textContent = Math.ceil(remain/1000) + '초 후 자동 닫힘';
      autoCloseTimer = setTimeout(tick, 200);
    };
    autoCloseTimer = setTimeout(tick, 200);

    // 사용자가 클릭하면 "무활동"이 아니므로 타이머를 그대로 두되, 다시 2초로 리셋하지는 않음
    // (요구사항: 2초 동안 아무런 클릭이 없어도 닫히도록)
  }

  function closeModal(){
    clearTimeout(autoCloseTimer);
    backdrop.style.display = 'none';
  }

  closeModalBtn.addEventListener('click', closeModal);
  backdrop.addEventListener('click', (e)=>{
    if(e.target === backdrop) closeModal();
  });

  // 초기 상태에서 권한 안내 및 기기 목록 시도
  if(!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)){
    alert('이 브라우저는 카메라 사용을 지원하지 않습니다.');
  }else{
    // iOS 등에서는 사용자 제스처 후에만 play가 가능하므로 자동 시작은 하지 않음
    listCameras();
  }

  // 페이지 숨김 시 카메라 정지(배터리/프라이버시)
  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden){ if(scanning) stopCamera(); }
  });

  // iOS에서 화면 껌 현상 방지(playsinline 사용, muted 설정됨)
  </script>
</body>
</html>
